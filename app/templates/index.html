<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBview.io - Media Review Platform</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Socket.IO client -->
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <style>
        .gradient-text {
            background: linear-gradient(90deg, #0ea5e9 0%, #10b981 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn-gradient {
            background: linear-gradient(90deg, #0ea5e9 0%, #10b981 100%);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold gradient-text">OBview.io</h1>
                </div>
                <div id="userSection" class="hidden">
                    <span id="username" class="mr-4 text-gray-700"></span>
                    <button id="logoutBtn" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300 text-gray-800 transition-colors">Logout</button>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="flex-grow">
            <!-- Auth forms -->
            <div id="authForms" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 grid md:grid-cols-2 gap-12">
                <div>
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-8">Welcome to OBview.io</h2>
                    
                    <!-- Login Form -->
                    <div id="loginForm" class="bg-white p-8 rounded-lg shadow-md mb-8">
                        <h3 class="text-xl font-semibold mb-4">Login</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="loginUsername" class="block text-sm font-medium text-gray-700">Username</label>
                                <input type="text" id="loginUsername" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <div>
                                <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="loginPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <div>
                                <button id="loginButton" class="w-full btn-gradient text-white py-2 px-4 rounded-md hover:opacity-90 transition-opacity">
                                    Login
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Register Form -->
                    <div id="registerForm" class="bg-white p-8 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Register</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="registerFullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                                <input type="text" id="registerFullName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <div>
                                <label for="registerUsername" class="block text-sm font-medium text-gray-700">Username</label>
                                <input type="text" id="registerUsername" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <div>
                                <label for="registerEmail" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="registerEmail" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <div>
                                <label for="registerPassword" class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="registerPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <div>
                                <button id="registerButton" class="w-full btn-gradient text-white py-2 px-4 rounded-md hover:opacity-90 transition-opacity">
                                    Create Account
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-teal-700 text-white rounded-lg overflow-hidden shadow-xl flex flex-col">
                    <div class="p-8 flex-grow flex flex-col justify-center">
                        <h2 class="text-3xl font-bold mb-6">Streamline Your Media Review Process</h2>
                        <p class="mb-6">OBview.io is a powerful platform for teams to collaborate on media projects. Upload videos, leave timestamped comments, and get approvals—all in one place.</p>
                        <ul class="space-y-2">
                            <li class="flex items-center">
                                <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                Secure, self-hosted solution
                            </li>
                            <li class="flex items-center">
                                <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                Timestamped comments & feedback
                            </li>
                            <li class="flex items-center">
                                <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                Simple approval workflow
                            </li>
                            <li class="flex items-center">
                                <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                Team collaboration tools
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard (hidden by default) -->
            <div id="dashboard" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="mb-8 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">My Projects</h2>
                    <button id="newProjectBtn" class="btn-gradient text-white py-2 px-4 rounded-md hover:opacity-90 transition-opacity">
                        New Project
                    </button>
                </div>
                
                <div id="projectsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Projects will be dynamically loaded here -->
                </div>
                
                <!-- New Project Modal (hidden by default) -->
                <div id="newProjectModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg max-w-md w-full p-6">
                        <h3 class="text-xl font-semibold mb-4">Create New Project</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="projectName" class="block text-sm font-medium text-gray-700">Project Name</label>
                                <input type="text" id="projectName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <div>
                                <label for="projectDescription" class="block text-sm font-medium text-gray-700">Description</label>
                                <textarea id="projectDescription" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"></textarea>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button id="cancelProjectBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100">
                                    Cancel
                                </button>
                                <button id="createProjectBtn" class="btn-gradient text-white py-2 px-4 rounded-md hover:opacity-90 transition-opacity">
                                    Create
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center">
                    <p>© 2025 OBview.io - All rights reserved</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Flash messages -->
    <div id="flash" class="fixed top-4 right-4 max-w-md z-50 hidden">
        <div id="flashContent" class="bg-white border-l-4 border-green-500 p-4 shadow-md rounded-md">
            <div class="flex">
                <div id="flashIcon" class="flex-shrink-0">
                    <svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <p id="flashMessage" class="text-sm text-gray-700"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const authForms = document.getElementById('authForms');
        const dashboard = document.getElementById('dashboard');
        const userSection = document.getElementById('userSection');
        const usernameSpan = document.getElementById('username');
        const loginBtn = document.getElementById('loginButton');
        const registerBtn = document.getElementById('registerButton');
        const logoutBtn = document.getElementById('logoutBtn');
        const projectsList = document.getElementById('projectsList');
        const newProjectBtn = document.getElementById('newProjectBtn');
        const newProjectModal = document.getElementById('newProjectModal');
        const cancelProjectBtn = document.getElementById('cancelProjectBtn');
        const createProjectBtn = document.getElementById('createProjectBtn');
        const flash = document.getElementById('flash');
        const flashContent = document.getElementById('flashContent');
        const flashMessage = document.getElementById('flashMessage');
        const flashIcon = document.getElementById('flashIcon');

        // Socket.IO connection
        let socket;
        
        // Current user data
        let currentUser = null;
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is already logged in
            checkAuthStatus();
            
            // Setup event listeners
            setupEventListeners();
        });

        // Check if user is already authenticated
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    currentUser = await response.json();
                    showDashboard();
                    fetchProjects();
                    connectWebsocket();
                } else {
                    showAuthForms();
                }
            } catch (error) {
                console.error('Auth check error:', error);
                showAuthForms();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Login form submission
            loginBtn.addEventListener('click', handleLogin);
            
            // Register form submission
            registerBtn.addEventListener('click', handleRegister);
            
            // Logout button
            logoutBtn.addEventListener('click', handleLogout);
            
            // New project button
            newProjectBtn.addEventListener('click', () => {
                newProjectModal.classList.remove('hidden');
            });
            
            // Cancel project creation
            cancelProjectBtn.addEventListener('click', () => {
                newProjectModal.classList.add('hidden');
                document.getElementById('projectName').value = '';
                document.getElementById('projectDescription').value = '';
            });
            
            // Create project
            createProjectBtn.addEventListener('click', handleCreateProject);
        }

        // Login handler
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showFlash('Please fill in all fields', 'error');
                return;
            }
            
            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    showFlash('Login successful!');
                    showDashboard();
                    fetchProjects();
                    connectWebsocket();
                } else {
                    const error = await response.json();
                    showFlash(error.error || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showFlash('Login failed. Please try again.', 'error');
            }
        }

        // Register handler
        async function handleRegister() {
            const name = document.getElementById('registerFullName').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            if (!name || !username || !email || !password) {
                showFlash('Please fill in all fields', 'error');
                return;
            }
            
            try {
                const response = await fetch('/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, username, email, password })
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    showFlash('Registration successful!');
                    showDashboard();
                    fetchProjects();
                    connectWebsocket();
                } else {
                    const error = await response.json();
                    showFlash(error.error || 'Registration failed', 'error');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showFlash('Registration failed. Please try again.', 'error');
            }
        }

        // Logout handler
        async function handleLogout() {
            try {
                await fetch('/auth/logout', { method: 'POST' });
                currentUser = null;
                showAuthForms();
                
                // Disconnect from websocket
                if (socket) {
                    socket.disconnect();
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Create project handler
        async function handleCreateProject() {
            const name = document.getElementById('projectName').value.trim();
            const description = document.getElementById('projectDescription').value.trim();
            
            if (!name) {
                showFlash('Project name is required', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, description })
                });
                
                if (response.ok) {
                    const project = await response.json();
                    showFlash('Project created successfully!');
                    newProjectModal.classList.add('hidden');
                    document.getElementById('projectName').value = '';
                    document.getElementById('projectDescription').value = '';
                    
                    // Add the new project to the list
                    addProjectToList(project);
                } else {
                    const error = await response.json();
                    showFlash(error.error || 'Failed to create project', 'error');
                }
            } catch (error) {
                console.error('Create project error:', error);
                showFlash('Failed to create project. Please try again.', 'error');
            }
        }

        // Fetch projects
        async function fetchProjects() {
            try {
                const response = await fetch('/api/projects');
                if (response.ok) {
                    const projects = await response.json();
                    renderProjects(projects);
                } else {
                    showFlash('Failed to load projects', 'error');
                }
            } catch (error) {
                console.error('Fetch projects error:', error);
                showFlash('Failed to load projects', 'error');
            }
        }

        // Render projects
        function renderProjects(projects) {
            projectsList.innerHTML = '';
            
            if (projects.length === 0) {
                projectsList.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <p class="text-gray-500">No projects yet. Create your first project!</p>
                    </div>
                `;
                return;
            }
            
            projects.forEach(project => {
                addProjectToList(project);
            });
        }

        // Add project to list
        function addProjectToList(project) {
            const date = new Date(project.created_at).toLocaleDateString();
            
            const projectCard = document.createElement('div');
            projectCard.className = 'bg-white rounded-lg shadow-md overflow-hidden';
            projectCard.innerHTML = `
                <div class="p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">${project.name}</h3>
                    <p class="text-gray-600 text-sm mb-4">${project.description || 'No description'}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">Created: ${date}</span>
                        <a href="/project/${project.id}" class="text-teal-600 hover:text-teal-800 text-sm font-medium">Open Project →</a>
                    </div>
                </div>
            `;
            
            projectsList.appendChild(projectCard);
        }

        // Show dashboard
        function showDashboard() {
            authForms.classList.add('hidden');
            dashboard.classList.remove('hidden');
            userSection.classList.remove('hidden');
            
            if (currentUser) {
                usernameSpan.textContent = currentUser.name || currentUser.username;
            }
        }

        // Show auth forms
        function showAuthForms() {
            dashboard.classList.add('hidden');
            authForms.classList.remove('hidden');
            userSection.classList.add('hidden');
        }

        // Show flash message
        function showFlash(message, type = 'success') {
            flashMessage.textContent = message;
            
            // Set the appropriate color based on the type
            if (type === 'error') {
                flashContent.classList.remove('border-green-500');
                flashContent.classList.add('border-red-500');
                flashIcon.innerHTML = `
                    <svg class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                `;
            } else {
                flashContent.classList.remove('border-red-500');
                flashContent.classList.add('border-green-500');
                flashIcon.innerHTML = `
                    <svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                `;
            }
            
            flash.classList.remove('hidden');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                flash.classList.add('hidden');
            }, 3000);
        }

        // Connect to WebSocket
        function connectWebsocket() {
            if (!socket) {
                socket = io();
                
                socket.on('connect', () => {
                    console.log('Connected to WebSocket');
                });
                
                socket.on('disconnect', () => {
                    console.log('Disconnected from WebSocket');
                });
                
                // Listen for real-time updates
                socket.on('new_comment', (data) => {
                    console.log('New comment:', data);
                    // Handle new comment notification
                });
                
                socket.on('approval_update', (data) => {
                    console.log('Approval update:', data);
                    // Handle approval update notification
                });
                
                socket.on('file_upload', (data) => {
                    console.log('New file uploaded:', data);
                    // Handle new file notification
                });
            }
        }
    </script>
</body>
</html>