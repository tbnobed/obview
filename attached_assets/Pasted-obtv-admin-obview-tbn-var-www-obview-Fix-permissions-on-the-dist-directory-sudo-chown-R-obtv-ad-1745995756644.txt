obtv-admin@obview-tbn:/var/www/obview$ # Fix permissions on the dist directory
sudo chown -R obtv-admin:obtv-admin /var/www/obview/dist

# Let's try running the compiled version directly without rebuilding
cd /var/www/obview

# Create a simple fix for the NeonDB connection issue without rebuilding
cat > /var/www/obview/neon-fix.js << 'EOF'
import { createRequire } from 'module';
const require = createRequire(import.meta.url);
const pg = require('pg');

// Mock the NeonDB module before it's imported
import.meta.resolve = async function(specifier, parentURL) {
  if (specifier === '@neondatabase/serverless') {
    return import.meta.url;
  }
  return Object.getPrototypeOf(import.meta).resolve.call(this, specifier, parentURL);
};

// Create a standard connection pool
const pool = new pg.Pool({
  connectionString: process.env.DATABASE_URL || 'postgres://obview:tbn123456789@localhost:5432/obview_db'
});

// Export a modified version of the NeonDB module
export const neonConfig = {
  webSocketConstructor: null,
  useSecureWebSocket: false
};

export class Pool {
  constructor() {
    return pool;
  }
}

// Start the actual application
import './dist/index.js';
EOF

# Make sure we have pg installed
npm install pg

# Start the application using our wrapper
NODE_ENV=production PORT=5000 HOST=0.0.0.0 DATABASE_URL=postgres://obview:tbn123456789@localhost:5432/obview_db node neon-fix.js

changed 5 packages, and audited 524 packages in 3s

67 packages are looking for funding
  run `npm fund` for details

7 moderate severity vulnerabilities

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
file:///var/www/obview/dist/index.js:343
neonConfig.webSocketConstructor = ws;
^

ReferenceError: neonConfig is not defined
    at file:///var/www/obview/dist/index.js:343:1
    at ModuleJob.run (node:internal/modules/esm/module_job:263:25)
    at async ModuleLoader.import (node:internal/modules/esm/loader:540:24)
    at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)

Node.js v20.19.1
obtv-admin@obview-tbn:/var/www/obview$